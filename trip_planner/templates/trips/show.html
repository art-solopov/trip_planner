{% extends "base.html" %}
{% from "macros/icon.html" import icon %}
{% from "macros/buttons.html" import hx_dialog_attrs %}

{% set button_classes = "button square round no-margin" %}

{% macro item_button(content, href, title='', classes='') %}
<a class="{{ button_classes }} {{ classes }}" title="{{ title }}" href="{{ href|default('#', true) }}"
                                              {%- if href -%}
                                                hx-get="{{ href }}" hx-select="[data-htmx-main]" hx-target="#data_drawer div:first-child"
                                              {%- endif -%}
                                              {{ kwargs|xmlattr }}>{{ content }}</a>
{% endmacro %}

{% block main %}
    <dialog class="left" id="main_app_drawer" popover>
        <div class="app">
            <header>
                <div class="trip-title row wrap max small-margin vertical-margin">
                    <h1 class="max">
                        <div>{{ trip.flag() }} {{ trip.name }}</div>
                        {#
                        <div class="trip-title-author">
                            by
                            {% if trip.belongs_to_current_user %}
                                <abbr class="you" title="{{ g.user.username }}">you</abbr>
                            {% else %}
                                {{ trip.author.username }}
                            {% endif %}
                        </div> #}
                    </h1>
                    <div class="ms-auto buttons">
                        <a href="{{ url_for('.add_point', key=trip.key) }}" class="{{ button_classes }} primary" title="Add point">{{ icon('add_circle') }}</a>
                        <a href="{{ url_for('.edit', key=trip.key) }}" class="{{ button_classes }} secondary" title="Edit">{{ icon('edit') }}</a>
                        <a class="{{ button_classes }} error" title="Delete" {{ hx_dialog_attrs(url_for('.delete_trip', key=trip.key)) }}>{{ icon('delete') }}</a>
                    </div>
                </div>
            </header>

            {%- for g_type, pts in points %}
                <section class="trip-point-items is-{{ g_type | lower }} vertical-margin">
                    <h2 class="small tiny-padding">{{ g_type | capitalize }}</h2>
                    <ul class="vertical-margin">
                        {%- for point in pts %}
                            <li class="trip-point-item small-margin vertical-margin"
                                id="{{ point.id }}"
                                data-map-target="point"
                                data-lat="{{ point.lat }}"
                                data-lon="{{ point.lon }}"
                                data-category="{{ point.type }}"
                                data-buttons-row-link="{{ url_for('.buttons_row', key=trip.key, id=point.id) }}">
                                <div class="left-margin small-margin">
                                    <h3 class="small bold item-name">{{ point.name }}</h3>
                                    <address class="item-address no-margin">{{ point.address }}</address>
                                </div>
                                <div class="item-links" role="group" aria-label="Point controls">
                                    {# TODO: DRY #}

                                    {{ item_button(icon('explore'), href=None, title="Center map", classes='border secondary-border secondary-text pan-link', **{'data-action': 'click->map#panTo'}) }}
                                    {{ item_button(icon('open_in_new'), url_for('.show_point', key=trip.key, id=point.id), title="More", classes='tertiary more-link') }}
                                    {{ item_button(icon('edit'), url_for('.edit_point', key=trip.key, id=point.id), title="Edit", classes='secondary edit-link') }}
                                    <a class="{{ button_classes }} error delete-link" title="Delete" {{ hx_dialog_attrs(url_for('.delete_point', key=trip.key, id=point.id)) }}>{{ icon('delete') }}</a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </section>
            {% endfor %}
        </div>

        <nav class="right-align no-space">
            <button class="tertiary" popovertarget="main_app_drawer" popovertargetaction="hide">{{ icon('cancel') }} Cancel</button>
        </nav>
    </dialog>

    <dialog class="right" id="data_drawer" data-trip-show-target="dataDrawer" data-action="htmx:afterSwap->trip-show#showDataDrawer" popover>
        <div id="data_drawer_target">
        </div>

        <nav class="right-align no-space">
            <button class="tertiary" formmethod="dialog">{{ icon('cancel') }} Cancel</button>
        </nav>
    </dialog>

    <button class="app-drawer-button circle primary large small-elevate" popovertarget="main_app_drawer">{{ icon('menu') }}</button>

    <div class="trip-map" id="map" data-map-target="map" aria-label="Map">
        <div id="buttons_row" class="buttons-row" data-map-target="buttonRow" data-action="htmx:afterSettle->map#postActivateMarker"></div>
    </div>
{% endblock %}

{% block extra_head %}
    {# TODO: maybe install via npm #}
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css' rel='stylesheet' />

    <script type="application/json" id="point_colors">
        {{ points_colors_map | tojson }}
    </script>
    <style>
        {{ points_colors_css }}
    </style>
{% endblock %}

{% block extra_body %}
    {{ script_tag('trip_show') }}
    {{ style_tag('trip_show.js') }}
{% endblock %}
